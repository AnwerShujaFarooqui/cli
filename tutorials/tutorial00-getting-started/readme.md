# Build a GraphQL Serverless API for a Simple Schema using Panacloud CLI and Deploy it on AWS


In the last few years, the way we build and architect APIs has fundamentally altered and grown. To save money, become more agile, and drive innovation, businesses are [migrating from on-premises to public cloud deployment](https://www2.deloitte.com/xe/en/insights/industry/technology/technology-media-and-telecom-predictions/2021/cloud-migration-trends-and-forecast.html). They are switching from a [monolithic architecture to a microservices architecture](https://blog.dreamfactory.com/api-trends-from-monolithic-to-microservices/). [Serverless microservices](https://docs.aws.amazon.com/whitepapers/latest/microservices-on-aws/serverless-microservices.html) have evolved from traditional microservices. Rather than message-driven systems, [event-driven systems](https://developer.lightbend.com/docs/akka-platform-guide/concepts/message-driven-event-driven.html) are being developed. Infrastructure as Code (IaC) has emerged as one of the most essential DevOps approaches for delivering software in a continuous manner, predictably and repeatedly. It is the process of managing and supplying infrastructure using code rather than human operations. IaC has evolved into IaC with AWS CDK where you write your infrastructure setup and provisioning like you would your application source code.

[API-First Approach](https://blog.stoplight.io/api-first-api-design-first-or-code-first-which-should-you-choose) to App Development is becoming increasingly popular and when combined with API Design-First helps the developers build very high quality APIs. API specifications in the form of OpenAPI description or GraphQL schemas have been more and more of an obvious choice for companies wanting to build serious APIs using the Design-First approach. 

Panacloud API development workflow combines API Design-First approach with multi-tenant serverless APIs, event-driven architecture, and IaC to deliver very quality API with the least cost. The Panacloud CLI automates the Panacloud API development workflows. 


Before getting started with the Panacloud CLI you need to install the following packages and libraries:

1. Install [Node.js](https://nodejs.org/en/)
2. Install [AWS CLI Version 2.x](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html)
3. Install [AWS CDK Version 2](https://docs.aws.amazon.com/cdk/latest/guide/work-with-cdk-v2.html)
4. Install Globally [TypeScript](https://www.typescriptlang.org/download)

Now Globally Install Panacloud CLI:

npm install @panacloud/cli -g 

Panacloud workflows uses API-First and API Design-First approach in developing GraphQL APIs. Please read these articles to understand the approach:

[Schema-First GraphQL: The Road Less Travelled](https://blog.mirumee.com/schema-first-graphql-the-road-less-travelled-cf0e50d5ccff)

In order to start learning to develop Serverless GraphQL APIs we have developed a very simple schema in the `user.graphql` file at the root of this tutorial.

You can learn how to develop GraphQL schemas from [the schema official documentation](https://graphql.org/learn/schema/)

Now we will generate an AWS CDK project using the panacloud cli.

mkdir my_user_api

cd my_user_api

panacloud init

On the command promt answer the question:

Which Kind of Mutli-Tenant Serverless API? Select: Generate Multi-Tenant Serverless API Scaffolding from Schema

Select API Type? Select: GraphQL 

GraphQL Schema File Path: ../user.graphql

API Name: MyUserAPI

Nested Resolver: No

Select Database? Neptune (Graph) 

Now the MyUserAPI code is generated and available in the `my_user_api` directory.

Now lets review the different directories and files in the project generated by the CLI.

## Understand the Project Generated by the CLI

The CLI generated project in the `my_user_api` directory for a Serverless API given the GraphQL schema in the `user.graphql` file.  It is a [AWS Cloud Development Kit (CDK)](https://docs.aws.amazon.com/cdk/latest/guide/home.html) project using TypeScript. It comes with all the necessary code to develop and deploy a Serverless GraphQL API in the AWS Cloud.  This includes the provisioning of cloud infrastructure in code and Serverless stubs where developers may easily include their business logic. The project also provides pre-built mock lambda functions and unit tests to test your deployed APIs. 

The project code may be conceptually divided into two parts:

1. The code that is generated by the Panacloud CLI, and will continuously be updated by the CLI as your API schema evolves. If the developer edits and updated this code, it will be overwritten next time the schema is updated and Panacloud CLI update command is given.
2. The code that the developer edits and updates and contains the business logic for the APIs. This code is contained in the `editable_src/` directory. 

It is highly recommended that the developer only edit and update the code contained in the `editable_src/` directory because the rest of the code is generated and updated by the Panacloud CLI.

The generated project code includes the mock lambdas contained in the `mock_lambda` directory in the root project folder. Typically, the developer will write business logic in the stub lambdas contained in the `editable_src/lambdas/` directory. The configuration contained in the `editable_src/panacloudconfig.json` file decides which lambda the APIs will call. Therefore, the project may be using mock lambdas in some calls and the real stub lambdas in other calls. This flexibility allows the developer to seamlessly transition from mock APIs towards real APIs, without the API users and testers even noticing it. Also, the mock APIs may be deployed right away.

The API CDK stack (cloud infrastructure in code) is generated by the Panacloud CLI `panacloud init` command given the API schema. API development is an iterative process, therefore when the developer updates the API schema in the `editable_src/graphql/schema/` directory and runs the `panacloud update` command the project's CDK code is updated. Given this cycle, most of the CDK stack is generated and updated by the Panacloud CLI. However, the developer has the flexibility to add and update the CDK stack by adding and updating visitors in the `editable_src/aspects/` directory. The Panacloud framework uses [Aspects](https://docs.aws.amazon.com/cdk/latest/guide/aspects.html) to enhance generated constructs and add cloud constructs written by the API developers.

The `editable_src/` directory contains all the code which the developer edits.  

The `editable_src/lambdas/` directory contains all the lambda stubs where the developer writes the business logic.  

The `editable_src/panacloudconfig.json` file tells the Panacloud framework which lambda functions to call.

The `editable_src/aspects` directory contains all the CDK code which the developer adds to the project CDK stack.  

The `cdk.json` file tells the CDK Toolkit how to execute your app.


## Deploying the Serverless API Mocks in the AWS Cloud

Note: The official documentation of CDK version 2 is available [here](https://docs.aws.amazon.com/cdk/api/v2/)

Before we proceed to deploy the project lets first understand what it contains. 

If you have already not done so, you need to [bootstrap](https://docs.aws.amazon.com/cdk/latest/guide/bootstrapping.html) the cdk by using this command:

cdk bootstrap

Once we are done with bootstrapping we want to deploy the Mock Serverless APIs. 

The project is already generated for you, you just have to compile it:

npm run build

Then you have to deploy the project:

panacloud deploy

After deploying check out the `cdk-outputs.json` file in the project root it contains the URL and Key of the deployed APIs.

Now run the tests:

npm run test

When you want to destroy the deployed stack just give this command:

panacloud destroy


## Running Automated API Tests Against the Mock APIs

## Developing and Writing Business and Data Logic in the Stubs and Deploying in the AWS Cloud

## Running Automated API Tests Against the Real APIs

## Adding CDK Code in the Project

 










