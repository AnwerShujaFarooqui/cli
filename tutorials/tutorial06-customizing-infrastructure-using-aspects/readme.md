# Using cdk Aspects for Updating IAC (Infrastructure As Code) in Panacloud Cli!

## Getting Started

Create a `user.graphql` schema file in your app directory and generate an AWS CDK project using the panacloud cli.

    mkdir my_user_api

    cd my_user_api

    panacloud init

Answer the following question on the command prompt:

* GraphQL Schema File Path? ../user.graphql

* API Name? MyUserAPI

* Select Database? Neptune (Graph) 

* Select Query Language? Gremlin

Now the MyUserAPI code is generated and available in the `my_user_api` directory.

# Short Summary (You must read) 
#### You can also update your AWS Code as Infrastructure by using cdk aspects. Inside editable_src/aspects there will be two files i.e (AspectController.ts, DefaultVisitor.ts). AspectController.ts is calling Aspects.of(SCOPE).add() with a new aspect i.e DefaultVisitor.ts. You can use visitor pattern in DefaultVisitor.ts file. After appling visitor pattern you can simply deploy it.

## Example
In the existing example after setting up the project we are going to update our IAC (Infrastructure As Code). So we need to do it with aws aspects or visitor pattern. Here in this example I am going to add the envorinment valiable ONLY in `addUser` lambda. Following are the steps to follow.

* Inside editable_src/aspects/DefaultVisitor.ts add the following code 

     if(node.node.id === "myUserApiLambdaaddUser"){
      node.addEnvironment("name","xyz")
      }
* Save the code and deploy the stack the command 

    npm run deploy-dev

## Explaination of code

    if (node instanceof lambda.Function) {
          if(node.node.id === "myUserApiLambdaaddUser"){
        node.addEnvironment("name","xyz")
        }
    }

In the above snippet of code, in first condition visitor pattern checks that (Is node a instance of Lambda Function or Not?), If yes it checks second condition that if node has node with id of specific lambda i.e (myUserApiLambdaaddUser). If condition is true then add the envoirnment varibale in that lambda. 

## Understand the Project Generated by the CLI

This is a project for Multi-Tenant Serverless API development with [AWS Cloud Development Kit (CDK)](https://docs.aws.amazon.com/cdk/latest/guide/home.html) using TypeScript. It comes with all the necessary code to develop and deploy a Serverless GraphQL API in the AWS Cloud.  This includes the provisioning of cloud infrastructure in code and Serverless stubs where developers may easily include their business logic. The project also provides pre-built mock lambda functions and unit tests to test your deployed APIs. 

The project code may be conceptually divided into two parts:

1. The code that is generated by the Panacloud CLI, and will continuously be updated by the CLI as your API schema evolves. If the developer edits and updated this code, it will be overwritten next time the schema is updated and Panacloud CLI update command is given.
2. The code that the developer edits and updates and contains the business logic for the APIs. This code is contained in the `editable_src/` directory. 

It is highly recommended that the developer only edit and update the code contained in the `editable_src/` directory because the rest of the code is generated and updated by the Panacloud CLI.